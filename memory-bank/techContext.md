# 技术上下文 - Memory Bank 系统

## 技术栈概览

### 核心技术
- **文档格式**: Markdown (.md)
- **配置语言**: YAML/JSON (用于规则配置)
- **版本控制**: Git
- **编辑器**: Cursor (v0.48+)
- **AI模型**: Claude 3.7 Sonnet (推荐)

### 系统架构
```
┌─────────────────────────────────────┐
│         Cursor 编辑器               │
│    ┌─────────────────────────────┐   │
│    │      自定义模式系统         │   │
│    │  ┌─────────────────────────┐ │   │
│    │  │   Memory Bank 规则      │ │   │
│    │  │      引擎              │ │   │
│    │  └─────────────────────────┘ │   │
│    └─────────────────────────────┘   │
└─────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│       文件系统存储                  │
│  ┌─────────────────────────────────┐ │
│  │     memory-bank/               │ │
│  │   ├── 核心文件                 │ │
│  │   ├── 上下文文件               │ │
│  │   └── 阶段文件                 │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 开发环境

### 必需组件
1. **Cursor 编辑器**
   - 版本要求: 0.48+
   - 功能要求: 自定义模式支持
   - 配置: 启用自定义模式功能

2. **操作系统支持**
   - macOS (主要测试平台)
   - Windows (兼容)
   - Linux (兼容)

3. **文件系统要求**
   - UTF-8 编码支持
   - 长文件名支持
   - 符号链接支持 (可选)

### 推荐工具
- **Git**: 版本控制和协作
- **VS Code**: 备用编辑器 (兼容性)
- **Markdown预览工具**: 文档查看
- **文本编辑器**: 快速编辑支持

## 文件格式规范

### Markdown 标准
- **版本**: CommonMark 0.30
- **扩展**: GitHub Flavored Markdown (GFM)
- **编码**: UTF-8
- **换行**: LF (Unix风格)

### 文件命名约定
```
核心文件: camelCase.md
阶段文件: prefix-[identifier].md
归档文件: archive-[timestamp].md
```

### 目录结构标准
```
memory-bank/
├── *.md                    # 核心文件
├── creative/              # 创意阶段文档
│   └── creative-*.md
├── reflection/            # 反思文档
│   └── reflection-*.md
└── archive/              # 归档文档
    └── archive-*.md
```

## 规则系统技术

### 规则文件格式
- **主格式**: Markdown with YAML frontmatter
- **配置**: JSON/YAML 内嵌
- **模板**: Mustache/Handlebars 语法

### 分层加载机制
```
isolation_rules/
├── main.md                # 主规则入口
├── Core/                  # 核心规则
├── Level1-4/             # 复杂度特定规则
├── Phases/               # 阶段特定规则
└── visual-maps/          # 可视化流程图
```

### 规则优先级
1. **用户自定义规则** (最高优先级)
2. **项目特定规则**
3. **复杂度级别规则**
4. **核心系统规则** (最低优先级)

## 性能考虑

### 令牌优化
- **分层加载**: 按需加载规则文件
- **缓存策略**: 智能缓存常用规则
- **压缩**: 最小化规则文件大小
- **批处理**: 合并多个操作

### 文件I/O优化
- **异步读写**: 非阻塞文件操作
- **批量更新**: 减少磁盘写入次数
- **增量更新**: 只更新变更部分
- **备份策略**: 最小化备份开销

## 集成接口

### Cursor 编辑器集成
```javascript
// 自定义模式配置示例
{
  "name": "VAN",
  "instructions": "...",
  "tools": ["codebase_search", "read_file", "terminal"],
  "advanced_options": "..."
}
```

### 文件系统接口
```
读取操作: read_file(path, options)
写入操作: edit_file(path, content, instructions)
目录操作: list_dir(path)
搜索操作: grep_search(pattern, options)
```

### 外部工具集成
- **Git钩子**: 自动更新Memory Bank
- **CI/CD**: 集成到构建流程
- **文档生成**: 自动生成项目文档
- **备份系统**: 定期备份Memory Bank

## 安全和隐私

### 数据安全
- **本地存储**: 所有数据保存在本地
- **加密选项**: 支持文件级加密
- **访问控制**: 基于文件系统权限
- **审计日志**: 操作历史记录

### 隐私保护
- **无网络传输**: 纯本地操作
- **敏感信息过滤**: 自动检测和保护
- **匿名化选项**: 支持数据匿名化
- **清理工具**: 安全删除敏感数据

## 错误处理和调试

### 错误分类
1. **文件系统错误**: 权限、磁盘空间等
2. **格式错误**: Markdown语法、编码问题
3. **规则错误**: 规则加载、解析失败
4. **集成错误**: Cursor接口问题

### 调试工具
- **日志系统**: 详细的操作日志
- **验证工具**: 文件格式验证
- **诊断模式**: 系统健康检查
- **修复工具**: 自动修复常见问题

### 恢复机制
- **自动备份**: 定期创建备份点
- **回滚功能**: 恢复到之前状态
- **修复向导**: 引导式问题解决
- **重建工具**: 重新构建损坏文件

## 版本兼容性

### 向后兼容性
- **文件格式**: 保持向后兼容
- **规则系统**: 渐进式升级
- **API接口**: 版本化接口设计
- **迁移工具**: 自动升级助手

### 前向兼容性
- **扩展点**: 预留扩展接口
- **配置系统**: 灵活的配置选项
- **插件架构**: 支持第三方扩展
- **标准化**: 遵循开放标准

## 测试和质量保证

### 测试策略
- **单元测试**: 核心功能验证
- **集成测试**: 组件协作测试
- **端到端测试**: 完整工作流验证
- **性能测试**: 响应时间和资源使用

### 质量指标
- **代码覆盖率**: >90%
- **文档覆盖率**: 100%
- **性能基准**: 响应时间 <100ms
- **可靠性**: 99.9% 正常运行时间

### 持续改进
- **用户反馈**: 收集和分析用户体验
- **性能监控**: 实时性能指标
- **自动化测试**: CI/CD集成
- **定期审查**: 代码和架构审查
