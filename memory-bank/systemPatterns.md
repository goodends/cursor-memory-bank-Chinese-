# 系统模式 - Memory Bank 系统

## 架构模式

### 分层架构模式
Memory Bank 系统采用分层架构，确保关注点分离和模块化：

```
┌─────────────────────────────────────┐
│           用户界面层                │
│        (Cursor 自定义模式)          │
├─────────────────────────────────────┤
│           业务逻辑层                │
│      (模式工作流和规则引擎)         │
├─────────────────────────────────────┤
│           数据访问层                │
│       (Memory Bank 文件系统)       │
├─────────────────────────────────────┤
│           存储层                    │
│      (Markdown 文件和目录)          │
└─────────────────────────────────────┘
```

### 状态机模式
系统使用状态机模式管理开发流程的不同阶段：

```
VAN → PLAN → CREATIVE → IMPLEMENT → REFLECT → ARCHIVE
 ↑                                              ↓
 └──────────────── 循环 ←─────────────────────────┘
```

### 模板方法模式
每个模式都遵循统一的执行模板：
1. 读取当前状态
2. 加载相应规则
3. 执行模式特定逻辑
4. 更新Memory Bank
5. 准备下一阶段

## 设计原则

### 1. 单一职责原则 (SRP)
- 每个模式专注于开发流程的特定阶段
- 每个Memory Bank文件负责特定类型的信息
- 规则文件按功能和复杂度分层组织

### 2. 开放封闭原则 (OCP)
- 系统对扩展开放：可以添加新的模式和规则
- 系统对修改封闭：核心架构保持稳定
- 通过配置文件和模板支持定制

### 3. 依赖倒置原则 (DIP)
- 高层模式不依赖具体的文件格式
- 通过抽象接口访问Memory Bank数据
- 规则系统与具体实现解耦

### 4. 接口隔离原则 (ISP)
- 每个模式只访问需要的Memory Bank文件
- 规则按使用场景分组，避免冗余加载
- 最小化模式间的耦合

## 数据流模式

### 单向数据流
```
用户输入 → 模式处理 → Memory Bank更新 → 状态反馈
```

### 事件驱动模式
- 模式转换触发相应的更新事件
- Memory Bank文件变更通知相关组件
- 异步处理长时间运行的任务

## 文件组织模式

### 分层文件结构
```
memory-bank/
├── 核心文件 (项目基础信息)
│   ├── projectbrief.md
│   ├── activeContext.md
│   └── progress.md
├── 上下文文件 (领域特定信息)
│   ├── productContext.md
│   ├── techContext.md
│   └── systemPatterns.md
├── 工作文件 (动态内容)
│   ├── tasks.md
│   └── style-guide.md
└── 阶段文件 (模式特定输出)
    ├── creative/
    ├── reflection/
    └── archive/
```

### 命名约定模式
- **核心文件**: 驼峰命名 (activeContext.md)
- **阶段文件**: 前缀命名 (creative-[feature].md)
- **归档文件**: 时间戳命名 (archive-[task_id].md)

## 令牌优化模式

### 分层加载策略
1. **基础层**: 始终加载的核心规则
2. **模式层**: 按需加载的模式特定规则
3. **复杂度层**: 根据任务复杂度加载的详细规则

### 渐进式文档模式
- **级别1**: 最小化文档，快速执行
- **级别2**: 基础文档，标准流程
- **级别3**: 详细文档，综合规划
- **级别4**: 完整文档，架构级规划

## 错误处理模式

### 优雅降级
- 文件缺失时使用默认模板
- 规则加载失败时回退到基础规则
- 模式转换异常时保持当前状态

### 自恢复机制
- 自动检测和修复文件结构问题
- 智能重建损坏的Memory Bank文件
- 基于历史状态的回滚能力

## 扩展模式

### 插件架构
- 支持自定义模式的添加
- 规则系统的模块化扩展
- 第三方工具的集成接口

### 配置驱动
- 通过配置文件定制行为
- 模板系统支持个性化
- 规则优先级的动态调整

## 性能优化模式

### 懒加载
- 按需加载规则文件
- 延迟初始化大型数据结构
- 智能缓存常用信息

### 批处理
- 批量更新Memory Bank文件
- 合并多个小的文件操作
- 减少磁盘I/O次数

## 安全模式

### 数据完整性
- 文件变更的原子性操作
- 备份和恢复机制
- 变更历史的完整记录

### 访问控制
- 基于模式的文件访问权限
- 敏感信息的保护机制
- 操作审计和日志记录

## 测试模式

### 分层测试策略
- **单元测试**: 单个模式的功能验证
- **集成测试**: 模式间的协作验证
- **系统测试**: 完整工作流的端到端验证

### 模拟和存根
- Memory Bank文件的模拟实现
- 规则系统的存根接口
- 外部依赖的隔离测试
